# API сервис для абстрактной биллинговой системы

| [English version](https://github.com/KonstErz/Test_task_API_for_billing_system/blob/master/README.md) |

### Сервис реализован с помощью инструментов Django, Django REST framework

---


# Структура базы данных

База данных сервиса представлена следующими объектами и моделями (http://localhost:8000/admin/)

## Модели API приложения

+ **ВАЛЮТА** (*Сurrency*)  
Имеет поле *Name* - наименование валюты по стандарту ISO 4217 в виде трехбуквенного алфавитного кода (alfa-3) в верхнем регистре (USD, EUR и т.д.)

+ **КУРС ВАЛЮТ** (*Exchange Rate*)  
Имеет поля:  
*Currency Numerator* - валюта-числитель (внешний ключ к модели Currency);  
*Currency Denominator* - валюта-знаменатель (внешний ключ к модели Currency);  
*Current Rate* - текущий курс валюты-числителя по отношению к валюте-знаменателю

+ **КОШЕЛЕК** (*Wallet*)  
Имеет поля:  
*ID* - уникальный идентификатор кошелька (UUID - известен только владельцу кошелька);  
*Owner* - владелец кошелька (внешний ключ к модели User);  
*Balance* - текущая сумма средств на кошельке;  
*Сurrency* - валюта кошелька (внешний ключ к модели Currency)

## Токены авторизации

+ **ТОКЕНЫ** (*Tokens*)  
Имеет поля:  
*Key* - токен авторизации пользователя, создаваемый при регистрации нового пользователя в системе;  
*User* - имя пользователя (внешний ключ к модели User);  
*Created* - дата и время создания токена (регистрации пользователя в системе)  

## Данные аутентификации и авторизации

+ **ГРУППЫ** (*Groups*) - группы пользователей

+ **ПОЛЬЗОВАТЕЛИ** (*Users*)  
Профиль пользователя имеет поля:  
*Username* - имя пользователя;  
*Email Address* - адрес электронной почты;  
*First Name* - имя;  
*Last Name* - фамилия;  
*Staff Status* - статус сотрудника, определяющий права доступа пользователя в системе

---


# Функционал API приложения

Сервис предоставляет 6 основных функциональных единиц, которые поддерживают входные данные в формате JSON.


1.	**РЕГИСТРАЦИЯ ПОЛЬЗОВАТЕЛЯ**    (*Registration*)

(http://localhost:8000/api/registration/)

Создает нового пользователя в системе.
Возвращает ID нового пользователя.

***Sample input content:***  
`{"username": "John", "email": "travolta54@domain.com", "password": "thmstdiffcltpasswd955"}`

где поля:  
*username* - желаемое имя профиля пользователя в системе;  
*email* - адрес электронной почты;  
*password* - пароль для авторизации пользователя в системе


2.	**АВТОРИЗАЦИЯ**    (*Login*)

(http://localhost:8000/api/login/)

Проводит аутентификацию пользователя в системе, осуществляет вход пользователя в его профиль, предоставляет доступ на проведение остальных операций в системе. 
Возвращает токен авторизации пользователя или ошибку с кодом 400 в случае неудачной аутентификации.

***Sample input content:***  
`{"username": "John", "password": "thmstdiffcltpasswd955"}`

где поля:  
*username* - имя профиля пользователя в системе;  
*password* - пароль для авторизации пользователя в системе


3.	**СОЗДАНИЕ КОШЕЛЬКА**    (*Wallet Creator*)

(http://localhost:8000/api/walletcreation/)

Создает новый кошелек, владелец которого идентифицируется по имени профиля пользователя в системе (username), с балансом по умолчанию равным 0 и с валютой, выбранной пользователем из доступного списка валют в БД системы.
Возвращает ID созданного кошелька.

***Sample input content:***  
`{"currency": "usd"}`

где поле *currency* - наименование желаемой валюты кошелька из доступного списка валют в БД системы 


4.	**ПОПОЛНЕНИЕ БАЛАНСА КОШЕЛЬКА**    (*Wallet Deposit*)

(http://localhost:8000/api/walletdeposit/)

Пополняет баланс (сумму средств) кошелька с текущей валютой кошелька на желаемую сумму.
Возвращает сообщение о пополнении баланса кошелька на желаемую сумму.

***Sample input content:***  
`{"wallet_id": "029f7ead-dc0e-410d-91cf-873e92d2b999", "amount": 5000}`

где поля:  
*wallet_id* - идентификатор кошелька (в формате UUID4), баланс которого пользователь желает пополнить;  
*amount* - количество средств, на которое следует пополнить баланс кошелька


5.	**КОНВЕРТАЦИЯ СРЕДСТВ**    (*Conversion*)

(http://localhost:8000/api/conversion/)

Производит перевод указанной суммы средств с одного кошелька пользователя на другой кошелек. Если валюты двух кошельков различаются, то проводится конвертация средств с учетом текущего внутреннего курса системы по данной валютной паре. 
Возвращает сообщение об успешной конвертации средств или ошибку с кодом 400 в случае нехватки средств (если пользователь указал сумму, превышающую текущий баланс на его кошельке).

***Sample input content:***  
`{"first_wallet_id": "029f7ead-dc0e-410d-91cf-873e92d2b999", "second_wallet_id": "acc65b3f-8944-4781-bc13-61f9eb8f2111", "amount": 500}`

где поля:  
*first_wallet_id* - идентификатор кошелька (в формате UUID4), с баланса которого спишется указанная сумма средств при конвертации;  
*second_wallet_id* - идентификатор кошелька (в формате UUID4), баланс которого пополнится на указанную сумму средств при конвертации;  
*amount* - количество средств, на которое следует осуществить конвертацию


6.	**ТРАНЗАКЦИЯ СРЕДСТВ ДРУГОМУ ПОЛЬЗОВАТЕЛЮ**    (*Transaction*)

(http://localhost:8000/api/transaction/)

Производит перевод указанной суммы средств с кошелька одного пользователя на кошелек другого пользователя.
В том случае, если валюта кошелька отправителя не совпадает с валютой кошелька получателя, то проводит автоматическую конвертацию средств с учетом текущего внутреннего курса системы по данной валютной паре. 
Возвращает сообщение об успешной транзакции средств или ошибку с кодом 400 в случае нехватки средств (если пользователь указал сумму, превышающую текущий баланс на его кошельке).

***Sample input content:***  
`{"username": "Uma", "currency": "usd", "my_wallet_id": "029f7ead-dc0e-410d-91cf-873e92d2b999", "amount": 2500}`

где поля:  
*username* - имя профиля пользователя в системе, по которому идентифицируется кошелек, баланс которого пополнится на указанную сумму средств при транзакции;  
*currency* - наименование валюты кошелька, баланс которого пополнится на указанную сумму средств при транзакции;  
*my_wallet_id* - идентификатор кошелька (в формате UUID4), с баланса которого спишется указанная сумма средств при транзакции;  
*amount* - количество средств, на которое следует осуществить транзакцию

---


### Особенности сервиса


***Преимущества***

+ Все операции, связанные с кошельками, могут проводить только пользователи, прошедшие авторизацию в системе;
+ Обработка большинства типичных ошибок, связанных с некорректным вводом данных;
+ Регистронезависимый ввод наименования валют;
+ Корректное арифметическое округление средств на балансе кошелька при операциях пополнения баланса кошелька, конвертации и транзакции средств;
+ Возможность автоматической конвертации средств при транзакции средств другому пользователю.


***Недостатки / недоработки***
+ При пополнении пользователем баланса кошелька должна учитываться возможность различия внешней валюты и текущей валюты кошелька, и при необходимости должна происходить автоконвертация платежа;
+ Внутренний курс валют в системе в идеале должен постоянно поддерживаться в актуальном состоянии за счет запросов на внешний API с данными курса валют в мире на текущий момент (такие услуги предоставляют, например, [ЦБ РФ](https://www.cbr.ru/development/DWS/), [Европейский Центробанк](https://www.ecb.europa.eu/stats/eurofxref/eurofxref-daily.xml), [Bloomberg](https://www.bloomberg.com/markets/currencies) и др.);
+ Формат отображения баланса кошелька пользователя (например, вещественное число с округлением до второго знака после точки) должен быть постоянным как при пополнении баланса, так и в результате операций по конвертации и транзакции средств, и не должен зависеть от формата того или иного значения курса валюты;
+ Тесты(!): на данный момент покрытие тестами конечных точек приложения составляет 0 %. В следствие чего, значительно усложняется поддержка кодовой базы при некорректной работе сервиса в результате внесения изменений в код :(
 
---


### Краткое руководство по быстрому запуску сервиса на вашем локальном компьютере

1.	Данный проект существует в виде docker-контейнера, для его корректной сборки и запуска на вашем локальном компьютере вам потребуется установить актуальую версию [Docker Engine](https://docs.docker.com/engine/install/) (вер. от *17.06.0* и выше).

2. Для сборки docker-образа вам потребуются файлы с переменными окружения *env.project* и *env.db*. Поэтому переименуйте файлы *env.project.example* и *env.db.example* из репозитория соответствующим образом. Эти файлы содержат переменные для корректной работы проекта. Вы можете изменить значения переменных под свои нужды.

3.  Чтобы произвести сборку образа, из корневой папки проекта выполните следующую команду в терминале:

    ```
    docker-compose build
    ```

4.  После успешной установки всех необходимых зависимостей, выполните запуск контейнера:

    ```
    docker-compose up -d
    ```

5.  С помощью следующей команды вы можете создать суперпользователя:

    ```
    docker-compose exec web python manage.py createsuperuser
    ```

6.  Теперь вы можете перейти на сервер http://localhost:8000/ в вашем браузере. Войдите под учетными данными созданного вами суперпользователя (http://localhost:8000/admin/ или http://localhost:8000/api/login/) и попробуйте создать несколько тестовых объектов каждого типа. Вы можете протестировать работу основного функционала приложения, например: создание кошелька (http://localhost:8000/api/walletcreation/), пополнение баланса (http://localhost:8000/api/walletdeposit/) и перевод средств другому пользователю (http://localhost:8000/api/transaction/).


Другие полезные команды, которые могут вам пригодиться в ходе работы с docker-контейнером проекта:
    
    docker-compose logs -f    # Вывод логов всех запущенных сервисов (Ctrl+C - для выхода)
    
    docker-compose down -v   # Удалить все тома вместе с контейнерами
    
    docker images       # Вывод списка всех запущенных образов
    docker images -a    # Вывод списка всех доступных образов
    
    docker ps       # Вывод списка всех запущенных контейнеров
    docker ps -a    # Вывод списка всех контейнеров
    
    docker stop $(docker ps -a -q)      # Остановить все контейнеры
    docker rm $(docker ps -a -q)     # Удалить все контейнеры

    docker rm <ID_or_Name>    # Удаление конкретного контейнера по ID или по имени
    
    docker rmi $(docker images -f dangling=true -q)    # Удаление всех образов, не помеченных тэгами
    
    docker rmi <Image_ID>    # Удаление конкретного образа по ID
    
    docker rmi $(docker images -a -q)    # Удаление всех образов
    
    docker rmi -f $(docker images -a -q)    # Форсированное удаление всех образов
    
